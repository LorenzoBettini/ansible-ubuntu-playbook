---
- name: Copy Dropbox apt key
  # The apt_key file is expected to be found on the remote host
  # so we first need to copy it
  become: true
  copy:
    src: "{{ playbook_dir }}/tasks/files/keys/dropbox.gpg"
    dest: "/tmp/"
    mode: 0600

- name: Add Dropbox key
  become: true
  apt_key:
    # use locally save key to avoid possible temporary failures
    file: "/tmp/dropbox.gpg"
    state: present

# This works with the updated GPG key
# maybe from 22.04 on.
- name: Add Dropbox apt repository with Distribution codename
  become: true
  apt_repository:
    repo: "deb [arch=i386,amd64] http://linux.dropbox.com/ubuntu {{ ansible_distribution_release }} main"
    state: present
    filename: dropbox

- name: Install Dropbox
  become: true
  apt:
    name: dropbox
    update_cache: yes
    state: present
  register: result
  retries: 5
  delay: 10
  until: result is not failed
# downloading from https://linux.dropbox.com/
# is extremely flaky, but ignoring errors might undermine idempotency